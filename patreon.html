<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Patreon Thanker</title>
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #020617;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #e5e7eb;
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app {
      min-height: 100vh;
      width: 100%;
      max-width: 1100px;
      padding: 2rem;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .card {
      background: #020617;
      border-radius: 1rem;
      border: 1px solid #1f2937;
      box-shadow: 0 25px 60px rgba(0,0,0,0.7);
      padding: 1.75rem 2rem;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 1rem;
    }

    .card-header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.03em;
    }

    .card-header p {
      margin: 0;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .controls {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1.5rem;
      align-items: start;
    }

    .dropzone {
      border-radius: 0.9rem;
      border: 1px dashed #4b5563;
      background: radial-gradient(circle at top left, #111827, #020617);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: border-color 0.15s ease, background-color 0.15s ease, transform 0.1s ease, box-shadow 0.1s ease;
    }

    .dropzone.dragover {
      border-color: #fbbf24;
      background: radial-gradient(circle at top left, #111827, #030712);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      transform: translateY(-1px);
    }

    .dropzone-title {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .dropzone-sub {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .file-input-wrapper {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .file-input-wrapper input[type="file"] {
      display: inline-block;
      font-size: 0.8rem;
      max-width: 100%;
    }

    .options {
      font-size: 0.8rem;
      color: #9ca3af;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .options label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
    }

    .options input[type="checkbox"] {
      cursor: pointer;
    }

    .status {
      font-size: 0.8rem;
      color: #9ca3af;
      min-height: 1.2em;
    }

    .output-label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }

    .output-label span {
      white-space: nowrap;
    }

    .output-label small {
      font-size: 0.7rem;
      color: #6b7280;
    }

    .output-wrapper {
      position: relative;
    }

    #output {
      width: 100%;
      min-height: 220px;
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      line-height: 1.4;
      white-space: pre-wrap;     /* preserve newlines, wrap long lines */
      word-wrap: break-word;
    }

    #output:focus {
      outline: 1px solid #6b7280;
      outline-offset: 1px;
      border-color: #9ca3af;
    }

    .substitutions {
      margin-top: 1.25rem;
    }

    #substitutions {
      width: 100%;
      min-height: 100px;
      max-height: 220px;
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    #substitutions:focus {
      outline: 1px solid #6b7280;
      outline-offset: 1px;
      border-color: #9ca3af;
    }

    @media (max-width: 800px) {
      .app {
        padding: 1rem;
      }
      .card {
        padding: 1.25rem 1.25rem 1.5rem;
      }
      .controls {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="card-header">
        <div>
          <h1>Patreon Thanker</h1>
          <p>Drop your Patreon CSV here and get newsletter-ready thank you text.</p>
        </div>
      </div>

      <div class="controls">
        <div>
          <div id="dropzone" class="dropzone">
            <div class="dropzone-title">Drop CSV file here</div>
            <div class="dropzone-sub">…or click to choose a file</div>
            <div class="file-input-wrapper">
              <input id="fileInput" type="file" accept=".csv,text/csv">
            </div>
          </div>
        </div>
      </div>

      <div class="options">
        <label>
          <input id="showAmounts" type="checkbox">
          Show total per patron in brackets
        </label>
        <label>
          <input id="initialMode" type="checkbox">
          Initial mode for anonymous patrons
        </label>
      </div>

      <div id="status" class="status"></div>

      <div>
        <div class="output-label">
          <span>Output</span>
          <small>Plain text, monospace. Copy and paste into the newsletter.</small>
        </div>
        <div class="output-wrapper">
          <textarea id="output" spellcheck="false" readonly></textarea>
        </div>
      </div>

      <div class="substitutions">
        <div class="output-label">
          <span>Name substitutions</span>
          <small>One per line: original, replacement. Stored in your browser.</small>
        </div>
        <textarea
          id="substitutions"
          spellcheck="false"
          placeholder="Fred West, Freddie West&#10;J Bloggs, Joe Bloggs"
        ></textarea>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('fileInput');
      const statusEl = document.getElementById('status');
      const outputEl = document.getElementById('output');
      const substitutionsEl = document.getElementById('substitutions');
      const showAmountsEl = document.getElementById('showAmounts');
      const initialModeEl = document.getElementById('initialMode');

      const SUBSTITUTIONS_COOKIE = 'patreon_thanker_subs';
      const INITIAL_MODE_COOKIE = 'patreon_thanker_initial_mode';
      const OUTPUT_HEIGHT_COOKIE = 'patreon_thanker_output_height';

      let currentSubstitutions = [];
      let lastPatrons = null;

      function setStatus(message, isError) {
        statusEl.textContent = message || '';
        statusEl.style.color = isError ? '#f97373' : '#9ca3af';
      }

      function clearOutput() {
        outputEl.value = '';
      }

      function handleError(err) {
        console.error(err);
        setStatus(typeof err === 'string' ? err : 'Something went wrong reading that CSV.', true);
        clearOutput();
      }

      function readFile(file) {
        if (!file) return;
        if (!/\.csv$/i.test(file.name) && file.type && !file.type.includes('csv')) {
          setStatus('That does not look like a CSV file, but I will try anyway…', true);
        } else {
          setStatus('Reading file…', false);
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const text = e.target.result;
            processCSV(text);
          } catch (err) {
            handleError(err);
          }
        };
        reader.onerror = function () {
          handleError('Could not read that file.');
        };
        reader.readAsText(file);
      }

      // Simple CSV parser (handles quotes and commas).
      function parseCSV(text) {
        const rows = [];
        let current = [];
        let value = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const c = text[i];

          if (c === '\r') {
            continue; // ignore CR, treat LF as row end
          }

          if (inQuotes) {
            if (c === '"') {
              const next = text[i + 1];
              if (next === '"') {
                value += '"';
                i++; // skip escaped quote
              } else {
                inQuotes = false;
              }
            } else {
              value += c;
            }
          } else {
            if (c === '"') {
              inQuotes = true;
            } else if (c === ',') {
              current.push(value);
              value = '';
            } else if (c === '\n') {
              current.push(value);
              rows.push(current);
              current = [];
              value = '';
            } else {
              value += c;
            }
          }
        }

        if (value.length > 0 || current.length > 0) {
          current.push(value);
          rows.push(current);
        }

        // Strip leading/trailing blank rows
        const cleaned = rows.filter(function (row) {
          return row.some(function (cell) { return (cell || '').trim() !== ''; });
        });

        return cleaned;
      }

      function cleanName(name) {
        if (!name) return '';
        const trimmed = name.trim();

        // Only treat as an email if it looks like a proper email address:
        // something@something.tld (with a dot in the domain).
        const emailMatch = trimmed.match(/^([^@\s]+)@([^@\s.]+)(?:\.[^@\s]+)+$/);
        if (emailMatch) {
          const local = emailMatch[1] || '';
          const domainMain = emailMatch[2] || '';
          return (local + ' ' + domainMain).trim();
        }

        // Otherwise, leave it as-is (so '@mattdawhit' stays '@mattdawhit').
        return trimmed;
      }

      function buildRecords(csvText) {
        const rows = parseCSV(csvText);
        if (!rows.length) {
          throw new Error('Empty CSV.');
        }

        // First non-empty row is the header
        const headerRow = rows[0].map(function (h) {
          return (h || '').replace(/\uFEFF/g, '').trim();
        });

        const headerIndex = {};
        headerRow.forEach(function (name, idx) {
          if (!name) return;
          headerIndex[name] = idx;
        });

        function get(row, name) {
          const idx = headerIndex[name];
          if (idx == null) return '';
          return (row[idx] || '').trim();
        }

        const needed = [
          'Name',
          'Patron Status',
          'Tier',
          'Lifetime Amount',
          'Free Member',
          'Patronage Since Date'
        ];

        needed.forEach(function (field) {
          if (!(field in headerIndex)) {
            throw new Error('Missing expected column: ' + field);
          }
        });

        const records = [];
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row || !row.length) continue;

          const rawName = get(row, 'Name');
          const name = cleanName(rawName);
          const status = get(row, 'Patron Status');
          const tier = get(row, 'Tier');
          const lifetimeRaw = get(row, 'Lifetime Amount');
          const freeMember = (get(row, 'Free Member') || '').toLowerCase();
          const sinceRaw = get(row, 'Patronage Since Date');

          if (!name && !status && !tier) {
            continue;
          }

          // Only active patrons
          if (status !== 'Active patron') {
            continue;
          }

          // Skip free members
          if (freeMember === 'yes') {
            continue;
          }

          const cleanedAmount = (lifetimeRaw || '').replace(/[^0-9.\-]/g, '');
          const lifetime = parseFloat(cleanedAmount) || 0;
          let lifetimeDisplay = '';
          if (lifetime) {
            lifetimeDisplay = lifetime.toFixed(2);
          }

          let since = null;
          if (sinceRaw) {
            // Normalise to ISO-ish string for Date parsing
            const iso = sinceRaw.replace(' ', 'T');
            const d = new Date(iso);
            if (!isNaN(d.getTime())) {
              since = d;
            }
          }

          records.push({
            name: name,
            tier: tier,
            lifetime: lifetime,
            lifetimeDisplay: lifetimeDisplay,
            since: since,
            rawSince: sinceRaw
          });
        }

        return records;
      }

      function sortByLifetimeDesc(list) {
        return list.slice().sort(function (a, b) {
          return (b.lifetime || 0) - (a.lifetime || 0);
        });
      }

      function sortByNewestFirst(list) {
        return list.slice().sort(function (a, b) {
          const ad = a.since ? a.since.getTime() : 0;
          const bd = b.since ? b.since.getTime() : 0;
          return bd - ad;
        });
      }

      function obscuredName(name) {
        // For no-thanks tier: first letter of each word, rest underscores.
        if (!name) return '';
        return name.split(/\s+/).map(function (word) {
          if (!word) return '';
          const first = word[0];
          let body = '';
          for (let i = 1; i < word.length; i++) {
            const ch = word[i];
            if (/[A-Za-z0-9]/.test(ch)) {
              body += '_';
            } else {
              body += ch;
            }
          }
          return first + body;
        }).join(' ');
      }

      function initialsFromName(name) {
        if (!name) return '';
        const trimmed = name.trim();
        if (!trimmed) return '';

        const parts = trimmed.split(/\s+/).filter(function (p) { return p; });
        function firstAlpha(str) {
          for (let i = 0; i < str.length; i++) {
            const ch = str[i];
            if (/[A-Za-z]/.test(ch)) return ch.toUpperCase();
          }
          return '';
        }

        if (parts.length >= 2) {
          const first = firstAlpha(parts[0]);
          const last = firstAlpha(parts[parts.length - 1]);
          const result = (first + last).trim();
          if (result) return result;
        }

        // Single word or fallback
        const only = parts[0];
        let initials = '';
        for (let i = 0; i < only.length; i++) {
          const ch = only[i];
          if (/[A-Za-z]/.test(ch)) {
            initials += ch.toUpperCase();
            if (initials.length === 2) break;
          }
        }
        if (!initials && only.length) {
          initials = only[0].toUpperCase();
        }
        return initials || '';
      }

      function joinWithAnd(items) {
        if (items.length === 0) return '';
        if (items.length === 1) return items[0];
        if (items.length === 2) return items[0] + ' and ' + items[1];
        return items.slice(0, -1).join(', ') + ', and ' + items[items.length - 1];
      }

      function joinWithAndNoCommas(items) {
        if (items.length === 0) return '';
        if (items.length === 1) return items[0];
        if (items.length === 2) return items[0] + ' and ' + items[1];
        return items.slice(0, -1).join(' ') + ' and ' + items[items.length - 1];
      }

      function pickRandom(arr) {
        if (!arr || !arr.length) return '';
        const idx = Math.floor(Math.random() * arr.length);
        return arr[idx];
      }

      function buildThankYouText(patrons) {
        if (!patrons.length) {
          return '  No active paying patrons found in that CSV.';
        }

        const TOP_TIERS = [
          'COMPANY SPONSORSHIP',
          '**** THANK YOU IN NEWSLETTER WITH CAPS AND ASTERISKS ****'
        ];
        const CAPS_TIER = 'THANK YOU IN NEWSLETTER IN CAPS';
        const THANK_YOU_TIER = 'Thank you in the newsletter';

        const showAmounts = !!(showAmountsEl && showAmountsEl.checked);
        const initialMode = !!(initialModeEl && initialModeEl.checked);

        const topGroup = sortByLifetimeDesc(
          patrons.filter(function (p) {
            return TOP_TIERS.indexOf(p.tier) !== -1;
          })
        );

        const capsGroup = sortByLifetimeDesc(
          patrons.filter(function (p) {
            return p.tier === CAPS_TIER;
          })
        );

        const thankYouGroup = sortByLifetimeDesc(
          patrons.filter(function (p) {
            return p.tier === THANK_YOU_TIER;
          })
        );

        const blankTierGroup = patrons.filter(function (p) {
          return !p.tier;
        });

        const newestTen = sortByNewestFirst(patrons).slice(0, 10);

        function decorateWithAmount(name, patron) {
          if (!showAmounts) return name;
          const display = patron.lifetimeDisplay;
          if (!display) return name;
          return name + ' ($' + display + ')';
        }

        // Paragraph 1: top tiers, caps and asterisks, ordered by lifetime.
        let para1 = '';
        if (topGroup.length) {
          const names = topGroup.map(function (p) {
            let base = p.name.toUpperCase();
            base = decorateWithAmount(base, p);
            return '*' + base + '*';
          });
          para1 = '  ' + joinWithAndNoCommas(names) + '.';
        }

        // Paragraph 2: CAPS tier, caps, comma separated.
        let para2 = '';
        if (capsGroup.length) {
          const names = capsGroup.map(function (p) {
            let base = p.name.toUpperCase();
            base = decorateWithAmount(base, p);
            return base;
          });
          para2 = '  ' + joinWithAnd(names) + '.';
        }

        // Paragraph 3: "Thank you in the newsletter" tier, as-is, comma separated.
        let para3 = '';
        if (thankYouGroup.length) {
          const names = thankYouGroup.map(function (p) {
            let base = p.name;
            base = decorateWithAmount(base, p);
            return base;
          });
          para3 = '  ' + joinWithAnd(names) + '.';
        }

        // Paragraph 4: blank tier.
        let para4 = '';
        if (blankTierGroup.length) {
          const count = blankTierGroup.length;

          if (initialMode) {
            const sortedBlank = sortByLifetimeDesc(blankTierGroup);
            const initialsList = sortedBlank.map(function (p) {
              let code = initialsFromName(p.name);
              code = decorateWithAmount(code, p);
              return code;
            }).filter(function (x) { return x; });

            const joinedInitials = joinWithAnd(initialsList);

            para4 = '  Also thanks to the ' + count +
              " lovely people who didn\u2019t opt to be thanked by name: " +
              joinedInitials + '. You are all legends.';
          } else {
            const adjectives = [
              'lovely',
              'wonderful',
              'brilliant',
              'excellent',
              'splendid',
              'delightful',
              'marvellous',
              'smashing'
            ];

            const closings = [
              "You're all smashing too.",
              'Much appreciated.',
              'We appreciate you lots.',
              'Thanks a million.',
              'Very much appreciated.',
              'You are all legends.'
            ];

            const adjective = pickRandom(adjectives) || 'lovely';
            const closing = pickRandom(closings) || 'Much appreciated.';

            para4 = '  Also thanks to the ' + count + ' ' + adjective +
              " people who didn\u2019t opt to be thanked by name in the newsletter. " + closing;
          }
        }

        // Paragraph 5: 10 newest members, formatted per tier.
        let para5 = '';
        if (newestTen.length) {
          const formatted = newestTen.map(function (p) {
            let base;
            if (TOP_TIERS.indexOf(p.tier) !== -1) {
              base = p.name.toUpperCase();
              base = decorateWithAmount(base, p);
              return '*' + base + '*';
            }
            if (p.tier === CAPS_TIER) {
              base = p.name.toUpperCase();
              base = decorateWithAmount(base, p);
              return base;
            }
            if (p.tier === THANK_YOU_TIER) {
              base = p.name;
              base = decorateWithAmount(base, p);
              return base;
            }
            // Blank / no-thanks tier
            if (!p.tier) {
              base = obscuredName(p.name);
              base = decorateWithAmount(base, p);
              return base;
            }
            // Any other odd tiers: just use the raw name.
            base = p.name;
            base = decorateWithAmount(base, p);
            return base;
          });

          para5 = '  And also thanks to our newest benefactors: ' + joinWithAnd(formatted) + '.';
        }

        // Stitch paragraphs together, skipping any empty ones, with a blank line between them.
        const paras = [para1, para2, para3, para4, para5].filter(function (p) { return p; });
        return paras.join('\n\n');
      }

      function loadSubstitutionsFromCookie() {
        const parts = document.cookie.split('; ');
        const match = parts.find(function (row) {
          return row.indexOf(SUBSTITUTIONS_COOKIE + '=') === 0;
        });
        if (!match) return '';
        try {
          return decodeURIComponent(match.split('=').slice(1).join('='));
        } catch (e) {
          return '';
        }
      }

      function saveSubstitutionsToCookie(value) {
        const encoded = encodeURIComponent(value || '');
        const expires = new Date();
        expires.setFullYear(expires.getFullYear() + 1);
        document.cookie =
          SUBSTITUTIONS_COOKIE + '=' + encoded +
          '; expires=' + expires.toUTCString() +
          '; path=/; SameSite=Lax';
      }

      function loadInitialModeFromCookie() {
        const parts = document.cookie.split('; ');
        const match = parts.find(function (row) {
          return row.indexOf(INITIAL_MODE_COOKIE + '=') === 0;
        });
        if (!match) return null;
        const value = match.split('=').slice(1).join('=');
        return value === '1';
      }

      function saveInitialModeToCookie(enabled) {
        const expires = new Date();
        expires.setFullYear(expires.getFullYear() + 1);
        document.cookie =
          INITIAL_MODE_COOKIE + '=' + (enabled ? '1' : '0') +
          '; expires=' + expires.toUTCString() +
          '; path=/; SameSite=Lax';
      }

      function loadOutputHeightFromCookie() {
        const parts = document.cookie.split('; ');
        const match = parts.find(function (row) {
          return row.indexOf(OUTPUT_HEIGHT_COOKIE + '=') === 0;
        });
        if (!match) return null;
        const value = match.split('=').slice(1).join('=');
        const h = parseInt(value, 10);
        if (!isNaN(h) && h > 0) {
          outputEl.style.height = h + 'px';
        }
        return h;
      }

      function saveOutputHeightToCookie() {
        if (!outputEl) return;
        const height = outputEl.offsetHeight;
        if (!height || height <= 0) return;

        const expires = new Date();
        expires.setFullYear(expires.getFullYear() + 1);
        document.cookie =
          OUTPUT_HEIGHT_COOKIE + '=' + height +
          '; expires=' + expires.toUTCString() +
          '; path=/; SameSite=Lax';
      }

      function parseSubstitutions(text) {
        const lines = (text || '').split(/\r?\n/);
        const subs = [];
        lines.forEach(function (line) {
          const trimmed = line.trim();
          if (!trimmed) return;
          const parts = trimmed.split(',');
          if (parts.length < 2) return;
          const from = parts[0].trim();
          const to = parts.slice(1).join(',').trim(); // allow commas in replacement
          if (!from || !to) return;
          subs.push({ from: from, to: to });
        });
        return subs;
      }

      function applySubstitutions(text, substitutions) {
        if (!text || !substitutions || !substitutions.length) return text;
        let result = text;
        substitutions.forEach(function (sub) {
          if (!sub.from) return;
          const fromEsc = sub.from.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp('\\b' + fromEsc + '\\b', 'g');
          result = result.replace(re, sub.to);
        });
        return result;
      }

      function updateSubstitutionsFromTextarea() {
        const value = substitutionsEl ? (substitutionsEl.value || '') : '';
        currentSubstitutions = parseSubstitutions(value);
        saveSubstitutionsToCookie(value);
      }

      function updateOutputFromPatrons() {
        if (!lastPatrons || !lastPatrons.length) return;
        const outText = buildThankYouText(lastPatrons);
        const finalText = applySubstitutions(outText, currentSubstitutions);
        outputEl.value = finalText;
        setStatus('Parsed ' + lastPatrons.length + ' active paying patrons.', false);
      }

      function processCSV(text) {
        try {
          const patrons = buildRecords(text);
          lastPatrons = patrons;
          const outText = buildThankYouText(patrons);
          const finalText = applySubstitutions(outText, currentSubstitutions);
          outputEl.value = finalText;
          if (patrons.length) {
            setStatus('Parsed ' + patrons.length + ' active paying patrons.', false);
          } else {
            setStatus('No active paying patrons found in that CSV.', true);
          }
        } catch (err) {
          handleError(err);
        }
      }

      // Event wiring
      dropzone.addEventListener('click', function () {
        if (fileInput) {
          fileInput.click();
        }
      });

      dropzone.addEventListener('dragover', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragleave', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      });

      dropzone.addEventListener('drop', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer && e.dataTransfer.files;
        if (files && files.length) {
          readFile(files[0]);
        }
      });

      if (fileInput) {
        fileInput.addEventListener('change', function (e) {
          const file = e.target.files && e.target.files[0];
          if (file) {
            readFile(file);
          }
        });
      }

      if (substitutionsEl) {
        // Load saved substitutions from cookie
        substitutionsEl.value = loadSubstitutionsFromCookie();
        updateSubstitutionsFromTextarea();

        substitutionsEl.addEventListener('input', function () {
          updateSubstitutionsFromTextarea();
        });
      }

      // Load initial mode from cookie
      const initialCookie = loadInitialModeFromCookie();
      if (initialModeEl && initialCookie !== null) {
        initialModeEl.checked = initialCookie;
      }

      if (initialModeEl) {
        initialModeEl.addEventListener('change', function () {
          saveInitialModeToCookie(initialModeEl.checked);
          updateOutputFromPatrons();
        });
      }

      if (showAmountsEl) {
        showAmountsEl.addEventListener('change', function () {
          updateOutputFromPatrons();
        });
      }

      // Load output height from cookie and save on mouseup (after resize)
      if (outputEl) {
        loadOutputHeightFromCookie();
        window.addEventListener('mouseup', function () {
          saveOutputHeightToCookie();
        });
      }

      // Initial hint
      setStatus('Drop a Patreon CSV above.', false);
      outputEl.value = '';
    })();
  </script>
</body>
</html>
